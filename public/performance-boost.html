<!-- 
  Domiradios Performance Optimizer
  Incluir este archivo en la página principal para mejorar rendimiento
  sin modificar el código base original
-->

<!-- Preload para recursos críticos -->
<link rel="preload" href="/css/performance.css" as="style">
<link rel="preload" href="/js/performance-optimizer.js" as="script">

<!-- Optimizaciones CSS -->
<link rel="stylesheet" href="/css/performance.css">

<!-- DNS Prefetch y Preconnect -->
<link rel="dns-prefetch" href="//fonts.googleapis.com">
<link rel="dns-prefetch" href="//fonts.gstatic.com">
<link rel="dns-prefetch" href="//cdn.jsdelivr.net">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- Configuración para Resource Hints -->
<meta http-equiv="x-dns-prefetch-control" content="on">

<!-- Script de optimización de carga -->
<script src="/js/performance-optimizer.js" defer></script>

<!-- Corrección para bloqueo de renderizado -->
<script>
  // Detectar y posponer scripts no críticos
  document.addEventListener('DOMContentLoaded', function() {
    // Marcar scripts críticos
    const criticalScripts = ['jquery', 'bootstrap', 'livewire'];
    
    // Posponer scripts no críticos
    document.querySelectorAll('script[src]').forEach(function(script) {
      const isCritical = criticalScripts.some(criticalScript => 
        script.src.includes(criticalScript)
      );
      
      if (!isCritical && !script.hasAttribute('defer') && !script.hasAttribute('async')) {
        // Clonar y reemplazar el script con versión diferida
        const newScript = document.createElement('script');
        newScript.src = script.src;
        newScript.defer = true;
        
        // Remover el script original
        const parent = script.parentNode;
        if (parent) {
          parent.removeChild(script);
          // Añadir el nuevo script al final del body
          document.body.appendChild(newScript);
        }
      }
    });
  });
  
  // Optimizar carga de imágenes
  window.addEventListener('load', function() {
    // Convertir imágenes a WebP si el navegador lo soporta
    if ('imageCapture' in window || 'createImageBitmap' in window) {
      document.querySelectorAll('img').forEach(function(img) {
        const src = img.getAttribute('src');
        if (src && !src.includes('.webp') && !src.includes('.svg') && !src.includes('data:image')) {
          // Comprobar si existe una versión WebP
          const webpSrc = src.replace(/\.(jpg|jpeg|png)$/i, '.webp');
          const webpImg = new Image();
          webpImg.onload = function() {
            img.src = webpSrc;
          };
          webpImg.src = webpSrc;
        }
      });
    }
    
    // Aplicar dimensiones explícitas a imágenes
    document.querySelectorAll('img:not([width]):not([height])').forEach(function(img) {
      if (img.complete) {
        img.setAttribute('width', img.naturalWidth);
        img.setAttribute('height', img.naturalHeight);
      } else {
        img.onload = function() {
          img.setAttribute('width', img.naturalWidth);
          img.setAttribute('height', img.naturalHeight);
        };
      }
    });
  });
</script>

<!-- Instrucciones de inclusión:
  1. Para usar este optimizador sin modificar tu código:
     
     Opción 1: Agrega este archivo via PHP include_once al final de tu layout principal
     <?php include_once(public_path('performance-boost.html')); ?>
     
     Opción 2: Usa un iframe oculto (con impacto mínimo)
     <iframe src="/performance-boost.html" style="display:none" title="Performance Optimizer"></iframe>
     
     Opción 3: Copia este código al final de tu layout principal antes del cierre </body>
-->
